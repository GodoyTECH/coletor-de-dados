<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><?= webAppTitle ?></title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* VARIÁVEIS GLOBAIS */
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --radius: 8px;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    /* RESET E BASE */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* HEADER */
    header {
      background: var(--card);
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    .header-left h1 { font-size: 1.25rem; margin-bottom: 0.25rem; color: var(--primary); }
    .header-left span { color: var(--muted); font-size: 0.875rem; }

    /* TABS */
    .tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .tab-btn {
      padding: 0.625rem 1.25rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 2rem;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .tab-btn:hover { border-color: var(--primary); background: #eff6ff; }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* MAIN CONTENT */
    main { padding: 1.5rem; max-width: 1200px; margin: 0 auto; }

    /* STATUS MESSAGE */
    #status {
      padding: 0.875rem 1rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      display: none;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.875rem;
    }
    #status.info { background: #dbeafe; border: 1px solid #bfdbfe; color: #1e40af; }
    #status.success { background: #d1fae5; border: 1px solid #a7f3d0; color: #065f46; }
    #status.error { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; }
    #status.warning { background: #fef3c7; border: 1px solid #fde68a; color: #92400e; }

    /* CARDS */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .card h2 {
      font-size: 1.125rem;
      margin-bottom: 1rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* DASHBOARD GRID */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.5rem 0;
      color: var(--primary);
    }
    .stat-card .label { color: var(--muted); font-size: 0.875rem; }

    /* TABLES */
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th {
      background: #f8fafc;
      padding: 0.875rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }
    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      font-size: 0.875rem;
    }
    tbody tr:hover { background: #f8fafc; }

    /* EDITABLE CELLS */
    .editable-cell {
      padding: 0.5rem;
      background: #f8fafc;
      border-radius: 4px;
      min-height: 2.5rem;
      outline: none;
      cursor: text;
      transition: background 0.2s;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .editable-cell:focus {
      background: white;
      outline: 2px solid var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .editable-cell.dirty {
      background: #eff6ff;
      outline: 2px solid rgba(59, 130, 246, 0.5);
    }

    /* BUTTONS */
    .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .btn {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn:active { transform: translateY(0); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-small { padding: 0.375rem 0.75rem; font-size: 0.75rem; }

    /* TABLE INFO */
    .table-info {
      color: var(--muted);
      font-size: 0.875rem;
      margin: 0.5rem 0;
      padding: 0.5rem 0;
    }

    /* LOADING */
    .loading { opacity: 0.6; pointer-events: none; }
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* UTILITIES */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .text-muted { color: var(--muted); }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; }
      .tabs { width: 100%; overflow-x: auto; padding-bottom: 0.5rem; }
      .tab-btn { flex-shrink: 0; }
      main { padding: 1rem; }
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-left">
      <h1><?= webAppTitle ?></h1>
      <span>Painel Administrativo - Social Coletor</span>
    </div>
    <nav class="tabs">
      <button class="tab-btn active" data-tab="dashboard">
        <i class="fas fa-chart-bar"></i> Dashboard
      </button>
      <button class="tab-btn" data-tab="registros">
        <i class="fas fa-database"></i> Registros
      </button>
      <button class="tab-btn" data-tab="duplicados">
        <i class="fas fa-clone"></i> Duplicados
      </button>
      <button class="tab-btn" data-tab="relatorios">
        <i class="fas fa-file-alt"></i> Relatórios
      </button>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <main>
    <!-- STATUS MESSAGE -->
    <div id="status"></div>

    <!-- DASHBOARD SECTION -->
    <section id="dashboard" class="tab-content">
      <div class="dashboard-grid">
        <div class="card stat-card">
          <h2><i class="fas fa-database"></i> Total de Registros</h2>
          <div class="value" id="totalRegistros">0</div>
          <div class="label">Registros no sistema</div>
        </div>
        <div class="card stat-card">
          <h2><i class="fas fa-check-circle"></i> Registros Ativos</h2>
          <div class="value" id="ativosRegistros">0</div>
          <div class="label">Registros válidos</div>
        </div>
        <div class="card stat-card">
          <h2><i class="fas fa-exclamation-triangle"></i> Duplicados</h2>
          <div class="value" id="duplicadosRegistros">0</div>
          <div class="label">Registros duplicados</div>
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-chart-pie"></i> Distribuição por Produto</h2>
        <div id="produtosChart">
          <p class="text-muted text-center"><i class="fas fa-spinner spinner"></i> Carregando dados...</p>
        </div>
      </div>
    </section>

    <!-- REGISTROS SECTION -->
    <section id="registros" class="tab-content hidden">
      <div class="card">
        <h2><i class="fas fa-table"></i> Gerenciamento de Registros</h2>

        <div class="actions">
          <button class="btn btn-secondary" onclick="resetRegistros()">
            <i class="fas fa-sync-alt"></i> Recarregar
          </button>
          <button class="btn btn-secondary" id="btnMaisRegistros" onclick="loadMoreRegistros()" style="display: none;">
            <i class="fas fa-plus"></i> Carregar Mais +20
          </button>
          <button class="btn btn-primary" id="btnSalvarRegistros" onclick="saveRegistros()" style="display: none;">
            <i class="fas fa-save"></i> Salvar Alterações
          </button>
        </div>

        <div class="table-info" id="registrosInfo">
          <i class="fas fa-spinner spinner"></i> Carregando registros...
        </div>

        <div class="table-container">
          <table id="registrosTable">
            <thead>
              <tr id="registrosHeaders">
                <!-- Headers serão preenchidos dinamicamente -->
              </tr>
            </thead>
            <tbody id="registrosBody">
              <tr>
                <td colspan="10" class="text-center">
                  <i class="fas fa-spinner spinner"></i> Carregando dados da planilha...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- DUPLICADOS SECTION -->
    <section id="duplicados" class="tab-content hidden">
      <div class="card">
        <h2><i class="fas fa-exclamation-triangle"></i> Registros Duplicados</h2>

        <div class="actions">
          <button class="btn btn-secondary" onclick="loadDuplicados()">
            <i class="fas fa-sync-alt"></i> Atualizar Lista
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Beneficiário</th>
                <th>Documento</th>
                <th>Produto</th>
                <th>Status</th>
                <th>Motivo</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="duplicadosBody">
              <tr>
                <td colspan="7" class="text-center">
                  <i class="fas fa-spinner spinner"></i> Buscando registros duplicados...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RELATÓRIOS SECTION -->
    <section id="relatorios" class="tab-content hidden">
      <div class="card">
        <h2><i class="fas fa-file-pdf"></i> Relatórios Gerados</h2>

        <div class="actions">
          <button class="btn btn-primary" onclick="gerarRelatorio()">
            <i class="fas fa-plus-circle"></i> Gerar Novo Relatório
          </button>
          <button class="btn btn-secondary" onclick="loadRelatorios()">
            <i class="fas fa-sync-alt"></i> Atualizar Lista
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Competência</th>
                <th>Total Registros</th>
                <th>Ativos</th>
                <th>Duplicados</th>
                <th>Data Geração</th>
                <th>PDF</th>
                <th>Resumo</th>
              </tr>
            </thead>
            <tbody id="relatoriosBody">
              <tr>
                <td colspan="7" class="text-center">
                  <i class="fas fa-spinner spinner"></i> Carregando relatórios...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- JAVASCRIPT -->
  <script>
    // ===== GLOBAL STATE =====
    const appState = {
      registros: {
        headers: [],
        data: [],
        pageSize: 20,
        currentPage: 0,
        totalCount: 0,
        hasMore: false,
        dirtyCells: new Map() // Map<rowId, Map<column, value>>
      },
      currentTab: 'dashboard'
    };

    // ===== UTILITY FUNCTIONS =====
    function showStatus(message, type = 'info', duration = 3000) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = type;
      statusEl.style.display = 'flex';

      if (duration > 0) {
        setTimeout(() => {
          if (statusEl.textContent === message) {
            statusEl.style.display = 'none';
          }
        }, duration);
      }
    }

    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(date) {
      if (!date) return '';
      try {
        const d = new Date(date);
        return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR').substring(0, 5);
      } catch {
        return date;
      }
    }

    // ===== TAB NAVIGATION =====
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      const tabElement = document.getElementById(tabId);
      if (tabElement) tabElement.classList.remove('hidden');

      const button = document.querySelector('[data-tab="' + tabId + '"]');
      if (button) button.classList.add('active');

      appState.currentTab = tabId;

      if (tabId === 'dashboard') loadDashboard();
      else if (tabId === 'registros') loadRegistros();
      else if (tabId === 'duplicados') loadDuplicados();
      else if (tabId === 'relatorios') loadRelatorios();
    }

    document.querySelectorAll('.tab-btn').forEach(button => {
      button.addEventListener('click', () => showTab(button.getAttribute('data-tab')));
    });

    // ===== DASHBOARD FUNCTIONS =====
    function loadDashboard() {
      showStatus('Carregando dados do dashboard...', 'info');
      google.script.run
        .withSuccessHandler(updateDashboard)
        .withFailureHandler(error => {
          console.error('Erro no dashboard:', error);
          showStatus('Erro ao carregar dashboard', 'error');
        })
        .getDashboardData();
    }

    function updateDashboard(data) {
      try {
        document.getElementById('totalRegistros').textContent = data.total || 0;
        document.getElementById('ativosRegistros').textContent = data.ativos || 0;
        document.getElementById('duplicadosRegistros').textContent = data.duplicados || 0;

        const produtosDiv = document.getElementById('produtosChart');
        if (data.porProduto && Object.keys(data.porProduto).length > 0) {
          let html = '<div style="max-width: 500px; margin: 0 auto;">';
          Object.entries(data.porProduto).forEach(([produto, quantidade]) => {
            const percent = data.total > 0 ? ((quantidade / data.total) * 100).toFixed(1) : 0;
            html += `
              <div style="margin-bottom: 0.75rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span><strong>${escapeHtml(produto)}</strong></span>
                  <span>${quantidade} (${percent}%)</span>
                </div>
                <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                  <div style="height: 100%; width: ${percent}%; background: var(--primary); border-radius: 4px;"></div>
                </div>
              </div>
            `;
          });
          html += '</div>';
          produtosDiv.innerHTML = html;
        } else {
          produtosDiv.innerHTML = '<p class="text-muted text-center">Nenhum produto registrado ainda.</p>';
        }

        showStatus('Dashboard atualizado', 'success', 2000);
      } catch (error) {
        console.error('Erro ao atualizar dashboard:', error);
        showStatus('Erro ao processar dados do dashboard', 'error');
      }
    }

    // ===== REGISTROS FUNCTIONS =====
    function resetRegistros() {
      appState.registros.currentPage = 0;
      appState.registros.data = [];
      appState.registros.dirtyCells.clear();
      loadRegistros();
    }

    function loadRegistros() {
      const registrosSection = document.getElementById('registros');
      if (registrosSection) registrosSection.classList.add('loading');

      showStatus('Carregando registros...', 'info');

      google.script.run
        .withSuccessHandler(handleRegistrosData)
        .withFailureHandler(error => {
          console.error('Erro ao carregar registros:', error);
          showStatus('Erro ao carregar registros: ' + (error?.message || error), 'error');
          if (registrosSection) registrosSection.classList.remove('loading');
        })
        .getRegistrosTable({
          limit: appState.registros.pageSize,
          offset: appState.registros.currentPage * appState.registros.pageSize
        });
    }

    // Normaliza a resposta do backend para evitar "Dados inválidos" por variações pequenas
    function normalizeRegistrosResponse(resp) {
      if (!resp) return { success: false, error: 'Resposta vazia do servidor' };

      // Caso backend retorne diretamente {headers, rows, meta}
      if (resp.success === undefined && resp.headers && resp.rows) {
        return { ...resp, success: true };
      }

      // Caso venha encapsulado
      if (resp.result && (resp.result.headers || resp.result.rows)) {
        const r = resp.result;
        if (r.success === undefined && r.headers && r.rows) return { ...r, success: true };
        return r;
      }

      return resp;
    }

    function handleRegistrosData(response) {
      const registrosSection = document.getElementById('registros');
      if (registrosSection) registrosSection.classList.remove('loading');

      const normalized = normalizeRegistrosResponse(response);

      if (!normalized || !normalized.success) {
        console.warn('Resposta inválida em Registros:', response);
        showStatus('Erro: ' + (normalized?.error || 'Dados inválidos do servidor'), 'error');
        return;
      }

      if (appState.registros.currentPage === 0) {
        appState.registros.headers = normalized.headers || [];
        renderRegistrosHeaders();
      }

      const newData = normalized.rows || [];
      if (appState.registros.currentPage === 0) appState.registros.data = newData;
      else appState.registros.data = [...appState.registros.data, ...newData];

      appState.registros.totalCount = normalized.meta?.total || 0;
      appState.registros.hasMore = normalized.meta?.hasMore || false;

      renderRegistrosBody();
      updateRegistrosControls();

      showStatus('Carregados ' + appState.registros.data.length + ' de ' + appState.registros.totalCount + ' registros', 'success', 2000);
    }

    function renderRegistrosHeaders() {
      const headersRow = document.getElementById('registrosHeaders');
      if (!headersRow || !appState.registros.headers.length) return;

      let html = '';
      appState.registros.headers.forEach(header => {
        html += '<th>' + escapeHtml(header) + '</th>';
      });
      headersRow.innerHTML = html;
    }

    function renderRegistrosBody() {
      const tbody = document.getElementById('registrosBody');
      if (!tbody) return;

      if (!appState.registros.data.length) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Nenhum registro encontrado</td></tr>';
        return;
      }

      let html = '';
      appState.registros.data.forEach((row, rowIndex) => {
        const sheetRowNumber = Number(row.rowNumber) || (2 + rowIndex + (appState.registros.currentPage * appState.registros.pageSize));
        const rowId = 'row-' + sheetRowNumber;

        html += '<tr data-row-id="' + rowId + '" data-row-number="' + sheetRowNumber + '">';

        appState.registros.headers.forEach((header, colIndex) => {
          const originalValue = row.values?.[colIndex] ?? '';
          const dirtyValue = appState.registros.dirtyCells.get(rowId)?.get(header);
          const displayValue = dirtyValue !== undefined ? dirtyValue : originalValue;
          const isDirty = dirtyValue !== undefined;

          // Tratamento especial para IMG_URL: exibe botão/link sem quebrar edição
          if (header === 'IMG_URL') {
            const url = String(displayValue || '').trim();
            html += '<td>';
            html += '<div class="editable-cell ' + (isDirty ? 'dirty' : '') + '" ';
            html += 'contenteditable="true" data-header="' + escapeHtml(header) + '" ';
            html += 'data-original="' + escapeHtml(originalValue) + '" ';
            html += 'data-row-id="' + rowId + '" ';
            html += 'oninput="markCellDirty(\'' + rowId + '\', \'' + header + '\', this.textContent)" ';
            html += 'onfocus="this.dataset.focused = \'true\'" ';
            html += 'onblur="this.dataset.focused = \'\'">';
            html += escapeHtml(url) + '</div>';
            if (url) {
              html += '<div class="mt-1">';
              html += '<a href="' + escapeHtml(url) + '" target="_blank" class="btn btn-secondary btn-small">';
              html += '<i class="fas fa-image"></i> Abrir imagem';
              html += '</a></div>';
            } else {
              html += '<div class="mt-1 text-muted">Sem imagem</div>';
            }
            html += '</td>';
            return;
          }

          html += '<td>';
          html += '<div class="editable-cell ' + (isDirty ? 'dirty' : '') + '" ';
          html += 'contenteditable="true" data-header="' + escapeHtml(header) + '" ';
          html += 'data-original="' + escapeHtml(originalValue) + '" ';
          html += 'data-row-id="' + rowId + '" ';
          html += 'oninput="markCellDirty(\'' + rowId + '\', \'' + header + '\', this.textContent)" ';
          html += 'onfocus="this.dataset.focused = \'true\'" ';
          html += 'onblur="this.dataset.focused = \'\'">';
          html += escapeHtml(displayValue) + '</div>';
          html += '</td>';
        });

        html += '</tr>';
      });

      tbody.innerHTML = html;
    }

    function markCellDirty(rowId, header, newValue) {
      if (!rowId || !header) return;

      const rowData = appState.registros.dirtyCells.get(rowId) || new Map();
      const cell = document.querySelector('[data-row-id="' + rowId + '"][data-header="' + header + '"]');
      const originalValue = cell?.getAttribute('data-original') || '';

      if (String(newValue).trim() === String(originalValue).trim()) {
        rowData.delete(header);
        if (rowData.size === 0) appState.registros.dirtyCells.delete(rowId);
        if (cell) cell.classList.remove('dirty');
      } else {
        rowData.set(header, newValue);
        appState.registros.dirtyCells.set(rowId, rowData);
        if (cell) cell.classList.add('dirty');
      }

      updateRegistrosControls();
    }

    function updateRegistrosControls() {
      const btnMais = document.getElementById('btnMaisRegistros');
      const btnSalvar = document.getElementById('btnSalvarRegistros');
      const info = document.getElementById('registrosInfo');

      if (btnMais) btnMais.style.display = appState.registros.hasMore ? 'inline-flex' : 'none';

      const hasChanges = appState.registros.dirtyCells.size > 0;
      if (btnSalvar) btnSalvar.style.display = hasChanges ? 'inline-flex' : 'none';

      if (info) {
        const loaded = appState.registros.data.length;
        const total = appState.registros.totalCount;
        const changes = appState.registros.dirtyCells.size;

        let infoText = 'Mostrando ' + loaded + ' de ' + total + ' registros';
        if (changes > 0) {
          infoText += ' | <span style="color: var(--warning);"><i class="fas fa-edit"></i> ' + changes + ' alteração(ões) pendente(s)</span>';
        }
        info.innerHTML = infoText;
      }
    }

    function loadMoreRegistros() {
      if (!appState.registros.hasMore) return;
      appState.registros.currentPage++;
      loadRegistros();
    }

    function saveRegistros() {
      if (appState.registros.dirtyCells.size === 0) {
        showStatus('Nenhuma alteração para salvar', 'info');
        return;
      }

      showStatus('Salvando alterações...', 'info', 0);

      // Prepara updates (garante rowNumber válido)
      const updates = [];
      appState.registros.dirtyCells.forEach((cellMap, rowId) => {
        const rowNumber = parseInt(String(rowId).replace('row-', ''), 10) || 0;
        if (rowNumber > 1) {
          const values = {};
          cellMap.forEach((value, header) => { values[header] = value; });
          updates.push({ rowNumber, values });
        }
      });

      if (updates.length === 0) {
        showStatus('Nenhuma alteração válida para salvar', 'warning');
        return;
      }

      // Uma única chamada ao backend (evita travar/quota)
      google.script.run
        .withSuccessHandler(result => {
          if (!result) {
            console.error('Resposta inválida ao salvar (null)');
            showStatus('Erro: resposta inválida do servidor ao salvar', 'error');
            return;
          }

          if (result.success) {
            showStatus('Alterações salvas com sucesso (' + (result.updated || updates.length) + ')', 'success');
            appState.registros.dirtyCells.clear();
            updateRegistrosControls();
            // Recarrega registros e dashboard para refletir mudanças
            resetRegistros();
            loadDashboard();
            return;
          }

          // Caso parcial/erro com detalhes
          const updated = result.updated || 0;
          const errs = Array.isArray(result.errors) ? result.errors : [];
          console.error('Erros no batch update:', errs);
          showStatus('Salvou ' + updated + ' linha(s), ' + errs.length + ' falhou(aram). Veja o console.', 'warning', 6000);

          // Ainda assim, recarrega para não ficar "travado"
          appState.registros.dirtyCells.clear();
          updateRegistrosControls();
          resetRegistros();
          loadDashboard();
        })
        .withFailureHandler(error => {
          console.error('Erro ao salvar (backend):', error);
          showStatus('Erro ao salvar alterações: ' + (error?.message || error), 'error', 6000);
        })
        .updateRegistroRowsBatch({ updates });
    }

    // ===== DUPLICADOS FUNCTIONS =====
    function loadDuplicados() {
      showStatus('Buscando registros duplicados...', 'info');
      google.script.run
        .withSuccessHandler(renderDuplicados)
        .withFailureHandler(error => {
          console.error('Erro ao carregar duplicados:', error);
          showStatus('Erro ao carregar duplicados', 'error');
        })
        .getDuplicados();
    }

    function renderDuplicados(duplicados) {
      const tbody = document.getElementById('duplicadosBody');
      if (!tbody) return;

      if (!duplicados || duplicados.length === 0) {
        tbody.innerHTML = '<tr>' +
          '<td colspan="7" class="text-center">' +
          '<i class="fas fa-check-circle" style="color: var(--success);"></i>' +
          ' Nenhum registro duplicado encontrado!' +
          '</td>' +
          '</tr>';
        showStatus('Nenhum duplicado encontrado', 'success');
        return;
      }

      let html = '';
      duplicados.forEach(registro => {
        const id = registro.ID || '';
        html += '<tr>' +
          '<td><code title="' + escapeHtml(id) + '">' + escapeHtml(id.substring(0, 8)) + '...</code></td>' +
          '<td>' + escapeHtml(registro.BENEFICIARIO || '') + '</td>' +
          '<td><strong>' + escapeHtml(registro.NUM_DOCUMENTO || '') + '</strong></td>' +
          '<td>' + escapeHtml(registro.PRODUTO || '') + '</td>' +
          '<td><span class="badge" style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:12px;">' + escapeHtml(registro.STATUS || '') + '</span></td>' +
          '<td>' + escapeHtml(registro.DUP_REASON || 'Documento duplicado') + '</td>' +
          '<td>' +
          '<div style="display: flex; gap: 4px; flex-wrap: wrap;">' +
          '<button class="btn btn-success btn-small" onclick="resolverDuplicado(\'' + escapeHtml(id) + '\', \'validar\')" title="Validar registro">' +
          '<i class="fas fa-check"></i>' +
          '</button>' +
          '<button class="btn btn-warning btn-small" onclick="resolverDuplicado(\'' + escapeHtml(id) + '\', \'manter\')" title="Manter como duplicado">' +
          '<i class="fas fa-pause"></i>' +
          '</button>' +
          '<button class="btn btn-danger btn-small" onclick="resolverDuplicado(\'' + escapeHtml(id) + '\', \'excluir\')" title="Excluir registro">' +
          '<i class="fas fa-trash"></i>' +
          '</button>' +
          '</div>' +
          '</td>' +
          '</tr>';
      });

      tbody.innerHTML = html;
      showStatus('Encontrados ' + duplicados.length + ' registros duplicados', 'success');
    }

    function resolverDuplicado(id, acao) {
      if (!confirm('Confirmar ação "' + acao + '" no registro ' + id.substring(0, 8) + '...?')) return;

      showStatus('Processando ' + acao + '...', 'info');

      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showStatus('Registro ' + acao + ' com sucesso!', 'success');
            loadDuplicados();
            if (appState.currentTab === 'dashboard') loadDashboard();
          } else {
            showStatus('Erro: ' + (result.error || 'Falha na ação'), 'error');
          }
        })
        .withFailureHandler(error => {
          console.error('Erro ao resolver duplicado:', error);
          showStatus('Erro ao processar ação', 'error');
        })
        .resolveDuplicado({ id, action: acao });
    }

    // ===== RELATÓRIOS FUNCTIONS =====
    function loadRelatorios() {
      showStatus('Carregando relatórios...', 'info');
      google.script.run
        .withSuccessHandler(renderRelatorios)
        .withFailureHandler(error => {
          console.error('Erro ao carregar relatórios:', error);
          showStatus('Erro ao carregar relatórios', 'error');
        })
        .getRelatorios();
    }

    function renderRelatorios(relatorios) {
      const tbody = document.getElementById('relatoriosBody');
      if (!tbody) return;

      if (!relatorios || relatorios.length === 0) {
        tbody.innerHTML = '<tr>' +
          '<td colspan="7" class="text-center">' +
          '<i class="fas fa-file"></i> Nenhum relatório gerado ainda' +
          '</td>' +
          '</tr>';
        showStatus('Nenhum relatório encontrado', 'info');
        return;
      }

      let html = '';
      relatorios.forEach(rel => {
        const resumo = String(rel.RESUMO || '');
        html += '<tr>' +
          '<td><strong>' + escapeHtml(rel.COMPETENCIA || '') + '</strong></td>' +
          '<td>' + (rel.TOTAL_REGISTROS || rel.TOTAL || 0) + '</td>' +
          '<td>' + (rel.TOTAL_ATIVOS || rel.ATIVOS || 0) + '</td>' +
          '<td>' + (rel.TOTAL_DUPLICADOS || rel.DUPLICADOS || 0) + '</td>' +
          '<td>' + formatDate(rel.CREATED_AT) + '</td>' +
          '<td>';
        if (rel.URL_PDF) {
          html += '<a href="' + escapeHtml(rel.URL_PDF) + '" target="_blank" class="btn btn-secondary btn-small">' +
            '<i class="fas fa-external-link-alt"></i> Abrir PDF' +
            '</a>';
        } else {
          html += '<span class="text-muted">Não disponível</span>';
        }
        html += '</td>' +
          '<td title="' + escapeHtml(resumo) + '">' +
          escapeHtml(resumo.substring(0, 60)) + (resumo.length > 60 ? '...' : '') +
          '</td>' +
          '</tr>';
      });

      tbody.innerHTML = html;
      showStatus('Carregados ' + relatorios.length + ' relatórios', 'success');
    }

    function gerarRelatorio() {
      if (!confirm('Deseja gerar um novo relatório da competência atual?')) return;

      showStatus('Gerando relatório... Isso pode levar alguns segundos.', 'info', 0);

      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showStatus('Relatório gerado com sucesso!', 'success');
            loadRelatorios();
          } else {
            showStatus('Erro: ' + (result.error || 'Falha ao gerar relatório'), 'error');
          }
        })
        .withFailureHandler(error => {
          console.error('Erro ao gerar relatório:', error);
          showStatus('Erro ao gerar relatório', 'error');
        })
        .gerarRelatorio();
    }

    // ===== INITIALIZATION =====
    function initializeApp() {
      console.log('Social Coletor Admin inicializando...');
      showTab('dashboard');

      document.addEventListener('keydown', event => {
        if (event.key === 'Escape') {
          const focusedCell = document.querySelector('.editable-cell[data-focused="true"]');
          if (focusedCell) {
            const original = focusedCell.getAttribute('data-original') || '';
            focusedCell.textContent = original;
            focusedCell.classList.remove('dirty');

            const rowId = focusedCell.getAttribute('data-row-id');
            const header = focusedCell.getAttribute('data-header');
            if (rowId && header) {
              const rowData = appState.registros.dirtyCells.get(rowId);
              if (rowData) {
                rowData.delete(header);
                if (rowData.size === 0) appState.registros.dirtyCells.delete(rowId);
                updateRegistrosControls();
              }
            }

            event.preventDefault();
          }
        }

        if (event.ctrlKey && event.key === 's') {
          event.preventDefault();
          if (appState.currentTab === 'registros' && appState.registros.dirtyCells.size > 0) {
            saveRegistros();
          }
        }
      });

      console.log('Aplicativo inicializado com sucesso');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
